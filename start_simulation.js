avvia();

async function avvia() {
    var geom = "[11.331281661987305,44.48649460196599],[11.333427429199217,44.490750137156354],[11.333727836608887,44.486310902809244],[11.335315704345701,44.4898623173159],[11.3358736038208,44.48557610039728],[11.33690357208252,44.48882140787868],[11.338748931884766,44.484382026736434],[11.34089469909668,44.48836217722139],[11.341753005981445,44.48478005400582],[11.342740058898926,44.487015079768476],[11.343941688537598,44.48459634944972],[11.345529556274414,44.48735185704834],[11.347246170043945,44.48376967178836],[11.349220275878906,44.48673953327506],[11.350765228271484,44.48297360074628],[11.352095603942871,44.48618843638337],[11.355056762695312,44.48340225573415],[11.354799270629881,44.48670891691767],[11.358404159545898,44.48618843638337],[11.353211402893066,44.489403094854104],[11.357889175415039,44.49032153616206],[11.349778175354004,44.49182162586243],[11.342911720275879,44.489801087863235],[11.346945762634277,44.48848463908355],[11.342997550964355,44.493291064077326],[11.332740783691406,44.49246450963717],[11.328620910644531,44.49537270483667],[11.322484016418457,44.49531148116906],[11.332011222839355,44.49913783686027],[11.335573196411133,44.495740045492575],[11.338920593261719,44.49791343035744],[11.34763240814209,44.49665838700844],[11.34239673614502,44.49941332478005],[11.336560249328613,44.50287211789361],[11.335701942443848,44.5005764816467],[11.337676048278809,44.49959698267009],[11.343812942504883,44.50155596416797],[11.331839561462402,44.49782159883325],[11.333041191101074,44.50014795286922],[11.337203979492188,44.49831136529107],[11.336688995361328,44.5005764816467],[11.348447799682617,44.50072952687536],[11.352224349975586,44.50244360598927],[11.356558799743652,44.50287211789361],[11.35535717010498,44.50002551549716],[11.355314254760742,44.49971942094208],[11.350722312927246,44.499627592262186],[11.353468894958496,44.50167839832613],[11.353769302368164,44.503300626648304],[11.353683471679688,44.496872664614436],[11.347117424011229,44.49681144252166],[11.350078582763672,44.49485230161302],[11.339821815490723,44.49613799525846],[11.343126296997069,44.49497474984816],[11.346130371093748,44.49408699431814],[11.354541778564453,44.49454617990028],[11.355271339416504,44.496535942308604],[11.358318328857422,44.49736243904283],[11.358447074890137,44.49365841784603],[11.353769302368164,44.492801255452854],[11.336088180541992,44.49420944416025],[11.343083381652832,44.49381148123335],[11.340937614440918,44.49439311844131],[11.334028244018555,44.49598493797759],[11.328706741333008,44.496321663465224],[11.329264640808105,44.493107386325235],[11.324543952941895,44.49197469407064],[11.324801445007324,44.49834197555811],[11.331110000610352,44.490566451401605],[11.337203979492188,44.490566451401605],[11.329565048217772,44.489219404857],[11.335616111755371,44.48977047311279],[11.3303804397583,44.48860710068857],[11.333384513854979,44.4853617812836],[11.336045265197754,44.48995416137438],[11.337890625,44.48465758436603],[11.33716106414795,44.488454023642106],[11.338191032409668,44.4883315617157],[11.337976455688477,44.48949493963571],[11.342911720275879,44.49090320817673],[11.350078582763672,44.4866476841547],[11.345744132995605,44.49301554723226],[11.334972381591797,44.49454617990028],[11.338105201721191,44.495740045492575],[11.341495513916016,44.49476046526792],[11.338319778442381,44.49916844669341],[11.337718963623047,44.50124987764774],[11.332097053527832,44.50161718127919],[11.335916519165039,44.499627592262186],[11.325702667236328,44.50274968624234],[11.349349021911621,44.500545872552756],[11.35136604309082,44.498495026652165],[11.348705291748047,44.50305576488844],[11.354327201843262,44.498984787453516],[11.354413032531738,44.501433529752724],[11.356086730957031,44.49818892406229],[11.352396011352539,44.50076013587287],[11.35711669921875,44.49843380626277],[11.35484218597412,44.502076307564394],[11.352782249450684,44.49883173764499],[11.355657577514648,44.49629105213761],[11.355786323547362,44.49950515379739],[11.35037899017334,44.502321173438084],[11.355228424072266,44.50066830883211],[11.35780334472656,44.50079074485433],[11.359648704528809,44.49717877411428],[11.359477043151855,44.49264818941406],[11.35037899017334,44.494913525762726],[11.347589492797852,44.49993368729936],[11.354713439941406,44.49197469407064],[11.351838111877441,44.494301281373104],[11.351408958435059,44.4935971923786]";
    var geomForArr = "[11.331281661987305,44.48649460196599] , [11.333427429199217,44.490750137156354] , [11.333727836608887,44.486310902809244] , [11.335315704345701,44.4898623173159] , [11.3358736038208,44.48557610039728] , [11.33690357208252,44.48882140787868] , [11.338748931884766,44.484382026736434] , [11.34089469909668,44.48836217722139] , [11.341753005981445,44.48478005400582] , [11.342740058898926,44.487015079768476] , [11.343941688537598,44.48459634944972] , [11.345529556274414,44.48735185704834] , [11.347246170043945,44.48376967178836] , [11.349220275878906,44.48673953327506] , [11.350765228271484,44.48297360074628] , [11.352095603942871,44.48618843638337] , [11.355056762695312,44.48340225573415] , [11.354799270629881,44.48670891691767] , [11.358404159545898,44.48618843638337] , [11.353211402893066,44.489403094854104] , [11.357889175415039,44.49032153616206] , [11.349778175354004,44.49182162586243] , [11.342911720275879,44.489801087863235] , [11.346945762634277,44.48848463908355] , [11.342997550964355,44.493291064077326] , [11.332740783691406,44.49246450963717] , [11.328620910644531,44.49537270483667] , [11.322484016418457,44.49531148116906] , [11.332011222839355,44.49913783686027] , [11.335573196411133,44.495740045492575] , [11.338920593261719,44.49791343035744] , [11.34763240814209,44.49665838700844] , [11.34239673614502,44.49941332478005] , [11.336560249328613,44.50287211789361] , [11.335701942443848,44.5005764816467] , [11.337676048278809,44.49959698267009] , [11.343812942504883,44.50155596416797] , [11.331839561462402,44.49782159883325] , [11.333041191101074,44.50014795286922] , [11.337203979492188,44.49831136529107] , [11.336688995361328,44.5005764816467] , [11.348447799682617,44.50072952687536] , [11.352224349975586,44.50244360598927] , [11.356558799743652,44.50287211789361] , [11.35535717010498,44.50002551549716] , [11.355314254760742,44.49971942094208] , [11.350722312927246,44.499627592262186] , [11.353468894958496,44.50167839832613] , [11.353769302368164,44.503300626648304] , [11.353683471679688,44.496872664614436] , [11.347117424011229,44.49681144252166] , [11.350078582763672,44.49485230161302] , [11.339821815490723,44.49613799525846] , [11.343126296997069,44.49497474984816] , [11.346130371093748,44.49408699431814] , [11.354541778564453,44.49454617990028] , [11.355271339416504,44.496535942308604] , [11.358318328857422,44.49736243904283] , [11.358447074890137,44.49365841784603] , [11.353769302368164,44.492801255452854] , [11.336088180541992,44.49420944416025] , [11.343083381652832,44.49381148123335] , [11.340937614440918,44.49439311844131] , [11.334028244018555,44.49598493797759] , [11.328706741333008,44.496321663465224] , [11.329264640808105,44.493107386325235] , [11.324543952941895,44.49197469407064] , [11.324801445007324,44.49834197555811] , [11.331110000610352,44.490566451401605] , [11.337203979492188,44.490566451401605] , [11.329565048217772,44.489219404857] , [11.335616111755371,44.48977047311279] , [11.3303804397583,44.48860710068857] , [11.333384513854979,44.4853617812836] , [11.336045265197754,44.48995416137438] , [11.337890625,44.48465758436603] , [11.33716106414795,44.488454023642106] , [11.338191032409668,44.4883315617157] , [11.337976455688477,44.48949493963571] , [11.342911720275879,44.49090320817673] , [11.350078582763672,44.4866476841547] , [11.345744132995605,44.49301554723226] , [11.334972381591797,44.49454617990028] , [11.338105201721191,44.495740045492575] , [11.341495513916016,44.49476046526792] , [11.338319778442381,44.49916844669341] , [11.337718963623047,44.50124987764774] , [11.332097053527832,44.50161718127919] , [11.335916519165039,44.499627592262186] , [11.325702667236328,44.50274968624234] , [11.349349021911621,44.500545872552756] , [11.35136604309082,44.498495026652165] , [11.348705291748047,44.50305576488844] , [11.354327201843262,44.498984787453516] , [11.354413032531738,44.501433529752724] , [11.356086730957031,44.49818892406229] , [11.352396011352539,44.50076013587287] , [11.35711669921875,44.49843380626277] , [11.35484218597412,44.502076307564394] , [11.352782249450684,44.49883173764499] , [11.355657577514648,44.49629105213761] , [11.355786323547362,44.49950515379739] , [11.35037899017334,44.502321173438084] , [11.355228424072266,44.50066830883211] , [11.35780334472656,44.50079074485433] , [11.359648704528809,44.49717877411428] , [11.359477043151855,44.49264818941406] , [11.35037899017334,44.494913525762726] , [11.347589492797852,44.49993368729936] , [11.354713439941406,44.49197469407064] , [11.351838111877441,44.494301281373104] , [11.351408958435059,44.4935971923786]";
    var arrayGeom = geomForArr.split(" , ");
    var formBody = [];

    var user = {
        username: "Luca",
        password: "6666"
    }

    var prenotazione = {
        di: "2021-08-11 11:05:00",
        df: "2021-08-11 11:05:00",
        utente: user.username,
        bici: 6,
        cod: "ciaoGerry!",
    }

    var noleggio = {
        codNoleggio: prenotazione.cod,
        bici: prenotazione.bici
    }

    var noleggioTerminato = {
        codNoleggio: prenotazione.cod,
        bici: prenotazione.bici,
        geom: "[" + geom + "]",
        rastrelliera: 1
    }


    /* Crea nuovo utente */
    await newUser();

    function newUser() {
        formBody = [];
        for (var property in user) {
            var encodedKey = encodeURIComponent(property);
            var encodedValue = encodeURIComponent(user[property]);
            formBody.push(encodedKey + "=" + encodedValue);
        }
        formBody = formBody.join("&");

        fetch('/registrazione', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: formBody,
        });
    }

    /* Faccio prenotare la bici 6 a tale utente. */
    await newPrenotazione();

    async function newPrenotazione() {
        formBody = [];
        for (var property in prenotazione) {
            var encodedKey = encodeURIComponent(property);
            var encodedValue = encodeURIComponent(prenotazione[property]);
            formBody.push(encodedKey + "=" + encodedValue);
        }
        formBody = formBody.join("&");

        fetch('/prenota', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: formBody,
        });
    }

    /* Faccio iniziare il noleggio. */
    await newNoleggio();

    async function newNoleggio() {
        formBody = [];
        for (var property in noleggio) {
            var encodedKey = encodeURIComponent(property);
            var encodedValue = encodeURIComponent(noleggio[property]);
            formBody.push(encodedKey + "=" + encodedValue);
        }
        formBody = formBody.join("&");

        fetch('/avvia_noleggio', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: formBody,
        });
    }

    /* Mandiamo le posizioni in tempo reale. Successivamente  (a posizioni finite) terminiamo il noleggio. */
    var i = 0;
    sendPositions();

    async function sendPositions() {

        formBody = [];
        var arrLatLng = arrayGeom[i].split(",");

        var coordinates = {
            long: arrLatLng[0].replace("[", ""),
            lat: arrLatLng[1].replace("]", ""),
            id: prenotazione.bici,
        }

        for (var property in coordinates) {
            var encodedKey = encodeURIComponent(property);
            var encodedValue = encodeURIComponent(coordinates[property]);
            formBody.push(encodedKey + "=" + encodedValue);
        }
        formBody = formBody.join("&");

        console.log(formBody);

        fetch('/addPosizione', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: formBody,
        }).then(() => {
            i++;
            if (i < arrayGeom.length){
                setTimeout(sendPositions, 1000);
            } else {
                terminaNoleggio();
            }
        });
    }

    /* Faccio terminare il noleggio. */
    async function terminaNoleggio() {
        formBody = [];
        for (var property in noleggioTerminato) {
            var encodedKey = encodeURIComponent(property);
            var encodedValue = encodeURIComponent(noleggioTerminato[property]);
            formBody.push(encodedKey + "=" + encodedValue);
        }
        formBody = formBody.join("&");

        await fetch('/termina_noleggio', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: formBody,
        });
    }
}